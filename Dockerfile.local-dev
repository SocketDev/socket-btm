# Local Development Dockerfile - Build binject/binpress with LIEF from source
#
# This Dockerfile is for local development and testing. It builds LIEF from source
# in the same container as binject/binpress to ensure perfect ABI compatibility.
# This matches the Depot.dev configuration (AlmaLinux 8, gcc 8.5.0, glibc 2.28).
#
# Usage:
#   docker buildx build --platform linux/amd64 \
#     -f Dockerfile.local-dev \
#     --target export \
#     --output type=local,dest=./build-output \
#     .
#
# The binaries will be exported to ./build-output/binject and ./build-output/binpress
#
# Requirements:
#   - Git submodules must be initialized (especially packages/bin-infra/upstream/lief)
#   - Run: git submodule update --init --recursive
#
FROM almalinux:8 AS lief-builder

# Install build dependencies (matching Depot.dev exactly)
RUN dnf -y update && \
    dnf -y install epel-release dnf-plugins-core && \
    dnf config-manager --set-enabled powertools && \
    dnf -y install \
        gcc-c++ \
        git \
        ccache \
        ninja-build \
        curl \
        ca-certificates \
        python3.11 \
        python3.11-pip \
        cmake \
        patch \
        glibc-static \
        libstdc++-static \
        openssl-devel \
        make \
        && \
    curl -fsSL https://rpm.nodesource.com/setup_lts.x | bash - && \
    dnf -y install nodejs && \
    npm install -g pnpm@10.26.1 && \
    dnf clean all

WORKDIR /workspace

# Copy workspace config and package files
COPY package.json pnpm-workspace.yaml pnpm-lock.yaml .gitmodules .node-version ./

# Copy packages (but NOT build/downloaded - we'll build LIEF from source)
COPY packages/build-infra/package.json packages/build-infra/
COPY packages/build-infra/lib packages/build-infra/lib
COPY packages/build-infra/make packages/build-infra/make
COPY packages/build-infra/scripts packages/build-infra/scripts
COPY packages/build-infra/src packages/build-infra/src

COPY packages/bin-infra/package.json packages/bin-infra/
COPY packages/bin-infra/src packages/bin-infra/src
COPY packages/bin-infra/scripts packages/bin-infra/scripts
COPY packages/bin-infra/patches packages/bin-infra/patches
COPY packages/bin-infra/upstream packages/bin-infra/upstream

COPY packages/binject/package.json packages/binject/
COPY packages/binject/src packages/binject/src
COPY packages/binject/scripts packages/binject/scripts
COPY packages/binject/Makefile* packages/binject/

COPY packages/binpress/package.json packages/binpress/
COPY packages/binpress/src packages/binpress/src
COPY packages/binpress/scripts packages/binpress/scripts
COPY packages/binpress/Makefile* packages/binpress/

# Build OpenSSL static library (required for SHA512 in binject)
RUN curl -fsSL https://www.openssl.org/source/openssl-1.1.1w.tar.gz -o /tmp/openssl.tar.gz && \
    cd /tmp && tar xzf openssl.tar.gz && cd openssl-1.1.1w && \
    ./config no-shared --prefix=/usr/local/ssl --openssldir=/usr/local/ssl && \
    make -j$(nproc) && \
    make install_sw && \
    cd / && rm -rf /tmp/openssl*

# Install liblzma (pre-built)
COPY packages/build-infra/build/downloaded/liblzma packages/build-infra/build/downloaded/liblzma
ARG TARGETARCH=amd64
RUN LIBLZMA_ARCH=$([ "$TARGETARCH" = "amd64" ] && echo "x64" || echo "arm64") && \
    LIBLZMA_DIR="packages/build-infra/build/downloaded/liblzma/linux-${LIBLZMA_ARCH}" && \
    cp -r "${LIBLZMA_DIR}/lib" /usr/local/ && \
    cp -r "${LIBLZMA_DIR}/include" /usr/local/

# Set library paths
ENV PKG_CONFIG_PATH=/usr/local/lib/pkgconfig:$PKG_CONFIG_PATH
ENV LDFLAGS="-L/usr/local/lib -L/usr/local/ssl/lib -lcrypto"
ENV CFLAGS="-I/usr/local/include -I/usr/local/ssl/include"
ENV CXXFLAGS=""

# Install dependencies
ENV CI=true
RUN pnpm install --frozen-lockfile

# Build LIEF from source (this ensures ABI compatibility)
WORKDIR /workspace/packages/bin-infra
ENV BUILD_MODE=dev
RUN if [ "$TARGETARCH" = "amd64" ]; then \
        export CFLAGS="$CFLAGS -march=x86-64 -mtune=generic" && \
        export CXXFLAGS="$CXXFLAGS -march=x86-64 -mtune=generic"; \
    fi && \
    pnpm run build:lief

# Build binject
WORKDIR /workspace/packages/binject
ENV BUILD_MODE=dev
RUN pnpm run build

# Build binpress
WORKDIR /workspace/packages/binpress
RUN pnpm run build

# Export binaries
FROM scratch AS export
COPY --from=lief-builder /workspace/packages/binject/build/dev/out/Final/binject /binject
COPY --from=lief-builder /workspace/packages/binpress/build/dev/out/Final/binpress /binpress
