/**
 * Generate ESM synchronous WASM wrapper.
 *
 * Transforms ESM async WASM module to ESM sync wrapper with:
 * - import.meta.url preserved (NOT transformed to __filename)
 * - No 'use strict' directive (not needed in ESM)
 * - export default for ESM compatibility
 */

import fs from 'node:fs/promises'
import path from 'node:path'

import { applyCommonTransforms } from './transform.mjs'

/**
 * Generate ESM synchronous wrapper.
 *
 * @param {object} options - Configuration options
 * @param {string} options.mjsContent - MJS glue code content
 * @param {string} options.base64Wasm - Base64-encoded WASM binary
 * @param {Uint8Array} options.wasmBinary - WASM binary
 * @param {string} options.mjsFile - Path to input MJS file
 * @param {string} options.outputSyncMjs - Path to output sync.mjs file
 * @param {string} options.packageName - Package name
 * @param {string} options.initFunctionName - Init function name
 * @param {string} options.exportName - Export name
 * @param {string} [options.description] - Optional description
 * @param {object} options.logger - Logger instance
 * @returns {Promise<string>} Path to generated file
 */
export async function generateSyncEsm(options) {
  const {
    base64Wasm,
    description,
    exportName,
    initFunctionName,
    logger,
    mjsContent: inputMjsContent,
    mjsFile,
    outputSyncMjs,
    packageName,
    wasmBinary,
  } = options

  let mjsContent = inputMjsContent

  // === Skip Pass 1 for ESM: Keep import.meta.url as is ===
  // ESM modules can use import.meta.url directly without transformation

  // === PASS 2 & 3: Apply common transformations ===
  mjsContent = await applyCommonTransforms({
    exportName,
    initFunctionName,
    logger,
    mjsContent,
  })

  // Build description line
  const descLine = description
    ? ` * ${description}`
    : ' * Built for synchronous instantiation.'

  // Get file size for documentation
  const mjsStats = await fs.stat(mjsFile)

  // Generate the ESM wrapper (no 'use strict', use export default)
  const mjsOutput = `/**
 * Synchronous ${packageName} with embedded WASM binary.
 *
 * This file is AUTO-GENERATED by ${packageName}-builder.
${descLine}
 *
 * Source: ${path.basename(mjsFile)} (${mjsStats.size} bytes)
 * WASM: ${wasmBinary.length} bytes (${base64Wasm.length} bytes base64)
 */

// Base64-encoded WASM binary (embedded at build time).
const base64Wasm = '${base64Wasm}';

// Decode base64 to Uint8Array.
const wasmBinary = Uint8Array.from(atob(base64Wasm), c => c.charCodeAt(0));

// Inlined Emscripten loader from ${packageName} build.
${mjsContent}

// Initialize ${packageName} with embedded WASM.
// Pass wasmBinary directly - Emscripten will use instantiateSync for synchronous loading.
const ${exportName}Promise = ${initFunctionName}({
  wasmBinary
});

// ESM export - export the promise
// Users must await this: const ${exportName} = await import('./${exportName}-sync.mjs');
export default ${exportName}Promise;
`

  await fs.writeFile(outputSyncMjs, mjsOutput, 'utf-8')

  const syncMjsSize = (await fs.stat(outputSyncMjs)).size
  logger.substep(`Sync MJS (ESM): ${outputSyncMjs}`)
  logger.substep(`Sync MJS size: ${(syncMjsSize / 1024).toFixed(2)} KB`)

  return outputSyncMjs
}
