name: 'Setup Checkpoint Caching'
description: 'Sets up checkpoint caching for package builds (load, restore, validate)'
inputs:
  package-name:
    description: 'Package name (e.g., binject, binpress, binflate)'
    required: true
  build-mode:
    description: 'Build mode (dev or prod)'
    required: true
  platform:
    description: 'Platform (e.g., darwin, linux, linux-musl, win32)'
    required: true
  arch:
    description: 'Architecture (x64, arm64)'
    required: true
  libc:
    description: 'C library type (glibc, musl, or empty for non-Linux)'
    required: false
    default: ''
outputs:
  cache-hit:
    description: 'Whether checkpoint cache was hit'
    value: ${{ steps.checkpoint-cache.outputs.cache-hit }}
  cache-valid:
    description: 'Whether checkpoint cache validation passed'
    value: ${{ steps.validate-cache.outputs.valid }}
  build-required:
    description: 'Whether build is required (checkpoint not restored)'
    value: ${{ steps.restore-checkpoint.outputs.build-required }}
  checkpoint-chain:
    description: 'Comma-separated checkpoint chain'
    value: ${{ steps.checkpoint-chain.outputs.checkpoint_chain }}
  cache-version:
    description: 'Cache version from cache-versions.json'
    value: ${{ steps.cache-version.outputs.version }}
  build-mode:
    description: 'Resolved build mode'
    value: ${{ steps.cache-key.outputs.build_mode }}
  lief-release:
    description: 'LIEF release tag used in cache key (for binsuite tools only)'
    value: ${{ steps.cache-key.outputs.lief_release }}
  cache-key:
    description: 'Full cache key for reuse'
    value: ${{ steps.cache-key.outputs.cache_key }}

runs:
  using: 'composite'
  steps:
    - name: Load cache version
      id: cache-version
      shell: bash
      run: |
        CACHE_VERSION=$(jq -r '.versions["${{ inputs.package-name }}"]' .github/cache-versions.json)
        if [ -z "$CACHE_VERSION" ] || [ "$CACHE_VERSION" = "null" ]; then
          echo "âŒ Error: Cache version not found for ${{ inputs.package-name }}"
          exit 1
        fi
        echo "version=$CACHE_VERSION" >> $GITHUB_OUTPUT
        echo "Cache version: $CACHE_VERSION"

    - name: Generate cache key
      id: cache-key
      shell: bash
      run: |
        # Cross-platform hash function
        if command -v shasum &> /dev/null; then
          hash_cmd="shasum -a 256"
        elif command -v sha256sum &> /dev/null; then
          hash_cmd="sha256sum"
        else
          echo "Error: No SHA-256 command found"
          exit 1
        fi

        CACHE_VERSION="${{ steps.cache-version.outputs.version }}"
        PACKAGE_NAME="${{ inputs.package-name }}"
        BUILD_MODE="${{ inputs.build-mode }}"

        # Hash source files, build scripts, Makefiles, and Dockerfiles.
        FIND_PATHS="packages/${PACKAGE_NAME}/src packages/${PACKAGE_NAME}/scripts packages/${PACKAGE_NAME}/Makefile* packages/${PACKAGE_NAME}/Dockerfile*"

        # BinSuite tools (binpress, binflate, binject) depend on bin-infra shared code.
        # Include bin-infra sources for BinSuite tools.
        if [[ "${PACKAGE_NAME}" == "binpress" ]] || [[ "${PACKAGE_NAME}" == "binflate" ]] || [[ "${PACKAGE_NAME}" == "binject" ]]; then
          FIND_PATHS="${FIND_PATHS} packages/bin-infra/src packages/bin-infra/scripts"
        fi

        SOURCE_HASH=$(find ${FIND_PATHS} -type f 2>/dev/null | sort | xargs $hash_cmd 2>/dev/null | $hash_cmd | cut -d' ' -f1 || echo "")

        # BinSuite tools download LIEF from releases.
        # Include LIEF release tag in cache key so cache is invalidated when LIEF is updated.
        LIEF_RELEASE=""
        if [[ "${PACKAGE_NAME}" == "binpress" ]] || [[ "${PACKAGE_NAME}" == "binflate" ]] || [[ "${PACKAGE_NAME}" == "binject" ]]; then
          # Get latest LIEF release tag.
          LIEF_RELEASE=$(gh release list --repo SocketDev/socket-btm --limit 100 2>/dev/null | grep -E '^.*lief-' | head -1 | awk '{print $3}' || echo "")
          if [ -n "$LIEF_RELEASE" ]; then
            echo "Using LIEF release: $LIEF_RELEASE"
          else
            echo "Warning: Could not determine LIEF release, cache may not invalidate on LIEF updates"
          fi
        fi

        FINAL_KEY=$(echo "${CACHE_VERSION}${SOURCE_HASH}${LIEF_RELEASE}" | $hash_cmd | cut -d' ' -f1)

        # Build full cache key.
        LIBC_SUFFIX="${{ inputs.libc && format('-{0}', inputs.libc) || '' }}"
        CACHE_KEY="${PACKAGE_NAME}-checkpoints-${CACHE_VERSION}-${{ inputs.platform }}-${{ inputs.arch }}${LIBC_SUFFIX}-${BUILD_MODE}-${FINAL_KEY}"

        echo "final_hash=${FINAL_KEY}" >> $GITHUB_OUTPUT
        echo "build_mode=${BUILD_MODE}" >> $GITHUB_OUTPUT
        echo "lief_release=${LIEF_RELEASE}" >> $GITHUB_OUTPUT
        echo "cache_key=${CACHE_KEY}" >> $GITHUB_OUTPUT

    - name: Restore checkpoint cache
      uses: actions/cache@1bd1e32a3bdc45362d1e726936510720a7c30a57 # v4.2.0
      id: checkpoint-cache
      with:
        path: |
          packages/${{ inputs.package-name }}/build/${{ steps.cache-key.outputs.build_mode }}/checkpoints
          packages/${{ inputs.package-name }}/build/shared/checkpoints
        key: ${{ steps.cache-key.outputs.cache_key }}

    - name: Get checkpoint chain
      id: checkpoint-chain
      shell: bash
      run: |
        CHAIN=$(node packages/${{ inputs.package-name }}/scripts/get-checkpoint-chain.mjs)
        echo "checkpoint_chain=$CHAIN" >> $GITHUB_OUTPUT
        CHECKPOINTS=$(echo "$CHAIN" | tr ',' ' ')
        echo "checkpoints=$CHECKPOINTS" >> $GITHUB_OUTPUT
        echo "Checkpoint chain: $CHAIN"

    - name: Validate checkpoint cache
      if: steps.checkpoint-cache.outputs.cache-hit == 'true'
      id: validate-cache
      uses: ./.github/actions/validate-checkpoints
      with:
        checkpoint-dirs: packages/${{ inputs.package-name }}/build/${{ steps.cache-key.outputs.build_mode }}/checkpoints:packages/${{ inputs.package-name }}/build/shared/checkpoints
        checkpoints: ${{ steps.checkpoint-chain.outputs.checkpoints }}
        package-name: ${{ inputs.package-name }}

    - name: Restore build output from checkpoint
      id: restore-checkpoint
      uses: ./.github/actions/restore-checkpoint
      with:
        package-name: ${{ inputs.package-name }}
        build-mode: ${{ steps.cache-key.outputs.build_mode }}
        checkpoint-chain: ${{ steps.checkpoint-chain.outputs.checkpoint_chain }}
        cache-hit: ${{ steps.checkpoint-cache.outputs.cache-hit }}
        cache-valid: ${{ steps.validate-cache.outputs.valid }}
